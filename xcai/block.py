# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/03_block.ipynb.

# %% auto 0
__all__ = ['CFGS', 'TFMS', 'XCBlock', 'prepare_batch']

# %% ../nbs/03_block.ipynb 2
import numpy as np, re, inspect
from typing import Optional, Dict
from transformers import AutoTokenizer, BatchEncoding, PreTrainedTokenizerBase

from fastcore.meta import *

from .data import *
from .transform import *
from .data_sampler import *

from .config import PARAM, WIKISEEALSOTITLES, WIKITITLES, WIKISEEALSO, WIKIPEDIA, ORCAS

# %% ../nbs/03_block.ipynb 5
CFGS = {
    'wikiseealsotitles':WIKISEEALSOTITLES, 
    'wikititles':WIKITITLES, 
    'wikiseealso':WIKISEEALSO, 
    'wikipedia':WIKIPEDIA,
    'orcas': ORCAS,
}

TFMS = {
    'xc': [XCPadFeatTfm, AlignInputIdsTfm], 
    'ng': [NGPadFeatTfm], 
    'xcnlg': [XCSamplePadFeatTfm], 
    'rm':[RamenPadFeatTfm],
    'xcs': [XCSamplerFeatTfm],
    'oak': [OAKSamplerFeatTfm],
}

# %% ../nbs/03_block.ipynb 7
class XCBlock:

    @delegates(XCDataBlock.from_cfg)
    @classmethod
    def from_cfg(
        cls, 
        data_dir:str, 
        cfg:str, 
        dset:Optional[str]='wikiseealsotitles', 
        bsz:Optional[int]=10, **kwargs
    ):
        """ Selecting the configuration """
        if dset not in CFGS: raise ValueError(f'Invalid `dset`({dset})')
        cfgs = CFGS[dset](data_dir)

        """ Selecting the dataset type """
        if cfg not in cfgs: raise ValueError(f'Invalid `cfg`({cfg})')
        cfg = cfgs[cfg] 

        """ Setting the parameters """
        for k in cfg['parameters']: 
            if k in kwargs: cfg['parameters'][k]=kwargs.pop(k)

        tokenizer = cfg['parameters']['tokenizer']
        tokz = tokenizer if isinstance(tokenizer, PreTrainedTokenizerBase) else AutoTokenizer.from_pretrained(tokenizer) 
        cfg['parameters']['sep_tok'] = tokz.sep_token_id 
        cfg['parameters']['pad_tok'] = tokz.pad_token_id
        cfg['parameters']['batch_size'] = bsz
        
        collator = XCCollator(TfmPipeline([o(**cfg['parameters']) for o in TFMS[cfg['parameters']['transform_type']]]))
        
        return XCDataBlock.from_cfg(cfg, collate_fn=collator, **kwargs)


# %% ../nbs/03_block.ipynb 20
def prepare_batch(m, b, m_args=None):
    m_kwargs = inspect.signature(m.forward).parameters
    return BatchEncoding({k:v for k,v in b.items() if k in m_kwargs or (m_args is not None and k in m_args)})
